{% extends "core/base.html" %}
{% load static %}

{% block title %}HospedAI ‚Äî Planejamento (Gantt){% endblock %}

{% block content %}
<style>
  :root{
    --ink:#0f172a;
    --muted:#6b7280;
    --primary:#4f46e5;
    --primary-2:#6366f1;
    --line:#e5e7eb;
    --bg:#f7f8fc;
  }

  .gantt-toolbar{
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    margin: 8px 0 14px;
  }
  .gantt-toolbar .side{
    display:flex; gap:8px; align-items:center;
  }
  .gantt-toolbar input[type="month"],
  .gantt-toolbar button{
    border:1px solid var(--line); background:#fff; color:var(--ink);
    padding:.5rem .75rem; border-radius:10px; cursor:pointer;
  }
  .gantt-toolbar button:hover{ border-color: var(--primary); }

  .gantt-wrap{
    background:var(--bg);
    border-radius:14px; padding:14px;
    box-shadow: 0 6px 18px rgba(15,23,42,.06);
  }

  .gantt-grid{
    display:grid;
    grid-template-columns: 200px 1fr;
    grid-template-rows: auto 1fr;
    border:1px solid var(--line);
    border-radius:12px;
    overflow:auto;
    background:#fff;
  }
  .gantt-header{
    grid-column:1/-1;
    display:grid;
    grid-template-columns:200px 1fr;
    position:sticky; top:0; z-index:5;
    background:#fff;
    border-bottom:1px solid var(--line);
  }
  .gantt-header .left{
    padding:.75rem .9rem; font-weight:700; color:var(--ink);
  }
  .gantt-header .days{
    display:grid; gap:0; border-left:1px solid var(--line);
  }
  .gantt-header .day{
    text-align:center; padding:.5rem 0;
    font-size:.9rem; border-left:1px solid var(--line);
    background:#fafafa;
  }

  .gantt-rows{ grid-column:1/-1; display:block; }
  .gantt-row{ display:grid; grid-template-columns:200px 1fr; }
  .gantt-row .label{
    background:#fff; border-right:1px solid var(--line);
    padding:.65rem .9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    border-bottom:1px solid var(--line);
  }
  .gantt-row .track{
    position:relative; min-height:38px; background:#fff;
    border-bottom:1px solid var(--line);
    z-index:1; overflow:hidden;
  }

  .bar{
    position:absolute; top:6px; height:26px; border-radius:8px;
    display:flex; align-items:center; gap:8px; padding:0 .55rem;
    color:#fff; font-weight:700; font-size:.86rem;
    box-shadow:0 6px 18px rgba(79,70,229,.25);
    white-space:nowrap; text-overflow:ellipsis;
    cursor:pointer;
  }
  .bar.confirmada{ background:linear-gradient(90deg,var(--primary),var(--primary-2)); }
  .bar.pendente{ background:linear-gradient(90deg,#f59e0b,#fbbf24); }
  .bar.cancelada{ background:linear-gradient(90deg,#ef4444,#f87171); }

  .track-grid{ position:absolute; inset:0; display:grid; pointer-events:none; }
  .track-grid > div{ border-left:1px dashed #eef0f4; }

  .legend{ display:flex; gap:12px; align-items:center; color:var(--muted); }
  .legend i{ width:14px; height:14px; border-radius:4px; display:inline-block; }
  .legend .c1{ background:linear-gradient(90deg,var(--primary),var(--primary-2)); }
  .legend .c2{ background:linear-gradient(90deg,#f59e0b,#fbbf24); }
  .legend .c3{ background:linear-gradient(90deg,#ef4444,#f87171); }

  /* Context Menu */
  .ctx-menu{
    position: fixed; z-index:50;
    background:#fff; border:1px solid var(--line);
    border-radius:10px; box-shadow:0 10px 30px rgba(15,23,42,.15);
    padding:.35rem; min-width:180px;
  }
  .ctx-menu button{
    width:100%; text-align:left; border:0; background:transparent;
    cursor:pointer; padding:.55rem .65rem; border-radius:8px;
    color:var(--ink);
  }
  .ctx-menu button:hover{ background:#f3f4f6; }

  /* Modal */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.25);
    z-index:40; display:flex; align-items:center; justify-content:center;
  }
  .modal{
    background:#fff; border-radius:14px; padding:1rem 1.1rem;
    width:min(92vw,440px);
    box-shadow:0 20px 50px rgba(2,6,23,.25);
  }
  .modal h3{ margin-bottom:.75rem; }
  .modal .row{ display:flex; gap:.5rem; margin:.5rem 0; }
  .modal input{ flex:1; padding:.55rem .6rem; border:1px solid var(--line); border-radius:10px; }
  .modal .actions{ display:flex; justify-content:flex-end; gap:.5rem; margin-top:.75rem; }
  .modal .actions button{
    border:1px solid var(--line); background:#fff; padding:.55rem .75rem; border-radius:10px; cursor:pointer;
  }
  .modal .actions .primary{
    background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; border:0;
  }
</style>

<div id="HospedAIGantt"></div>

<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

{% verbatim %}
<script type="text/babel">
const parseISO = (s)=> new Date(s);
function rangeToFrac(start, end, year, month, dias) {
  const base = new Date(year, month-1, 1,0,0,0,0);
  const endExclusive = new Date(year, month-1, dias+1,0,0,0,0);
  const msPerDay = 24*3600*1000;
  const clampStart = new Date(Math.max(start, base));
  const clampEnd   = new Date(Math.min(end, endExclusive));
  let fs = (clampStart-base)/msPerDay;
  let fe = (clampEnd-base)/msPerDay;
  fs=Math.max(0,Math.min(fs,dias));
  fe=Math.max(fs,Math.min(fe,dias));
  return [fs,fe];
}

function Toolbar({year,month,onMonthChange,onReload}){
  const prev=()=>{const d=new Date(year,month-2,1);onMonthChange(d.getFullYear(),d.getMonth()+1);}
  const next=()=>{const d=new Date(year,month,1);onMonthChange(d.getFullYear(),d.getMonth()+1);}
  const nice=new Date(year,month-1,1).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  const value=`${year}-${String(month).padStart(2,'0')}`;
  return(
    <div className="gantt-toolbar">
      <div className="side">
        <button onClick={prev}>‚óÄ</button>
        <strong>{nice}</strong>
        <button onClick={next}>‚ñ∂</button>
      </div>
      <div className="side">
        <input type="month" value={value} onChange={(e)=>{
          const [y,m]=e.target.value.split("-").map(Number);
          onMonthChange(y,m);
        }}/>
        <button onClick={onReload}>Recarregar</button>
      </div>
      <div className="legend">
        <span><i className="c1"></i> Confirmada</span>
        <span><i className="c2"></i> Pendente</span>
        <span><i className="c3"></i> Cancelada</span>
      </div>
    </div>
  );
}

function HeaderDays({dias}){
  const COL_W=80;
  const cols=Array.from({length:dias},(_,i)=>i+1);
  const style={gridTemplateColumns:`repeat(${dias}, ${COL_W}px)`,width:`${dias*COL_W}px`};
  return(
    <div className="gantt-header">
      <div className="left">Quarto</div>
      <div className="days" style={style}>
        {cols.map(d=><div key={d} className="day">{d}</div>)}
      </div>
    </div>
  );
}

function Row({room,year,month,dias,onBarClick}){
  const COL_W=80;
  const colsStyle={gridTemplateColumns:`repeat(${dias},${COL_W}px)`,width:`${dias*COL_W}px`};
  return(
    <div className="gantt-row">
      <div className="label" title={room.label}>{room.label}</div>
      <div className="track">
        <div className="track-grid" style={colsStyle}>
          {Array.from({length:dias}).map((_,i)=><div key={i}></div>)}
        </div>
        {room.reservas.map(r=>{
          const[start,end]=[parseISO(r.start),parseISO(r.end)];
          const[fs,fe]=rangeToFrac(start,end,year,month,dias);
          const leftPx=fs*COL_W;
          const widthPx=(fe-fs)*COL_W;
          const cls=`bar ${r.status||'confirmada'}`;
          return(
            <div key={r.id} className={cls}
              style={{left:`${leftPx}px`,width:`${widthPx}px`}}
              onClick={evt=>onBarClick(evt,r)}
              title={`${r.cliente||'Reserva'} (${r.status}) ‚Ä¢ ${r.start} ‚Üí ${r.end}`}>
              <span>{r.cliente||'‚Äî'}</span>
            </div>
          );
        })}
      </div>
    </div>
  );
}

function Grid({data,onBarClick}){
  const{ano,mes,dias,quartos}=data;
  return(
    <div className="gantt-grid">
      <HeaderDays dias={dias}/>
      <div className="gantt-rows">
        {quartos.map(q=><Row key={q.id} room={q} year={ano} month={mes} dias={dias} onBarClick={onBarClick}/>)}
      </div>
    </div>
  );
}

function ContextMenu({x,y,onConfirm,onCancel,onEdit}){
  return(
    <div className="ctx-menu" style={{left:x,top:y}} onClick={e=>e.stopPropagation()}>
      <button onClick={onConfirm}>‚úÖ Confirmar</button>
      <button onClick={onCancel}>üõë Cancelar</button>
      <button onClick={onEdit}>‚úèÔ∏è Alterar datas‚Ä¶</button>
    </div>
  );
}
function EditModal({start,end,setStart,setEnd,onClose,onSave}){
  return(
    <div className="modal-backdrop" onClick={onClose}>
      <div className="modal" onClick={e=>e.stopPropagation()}>
        <h3>Alterar per√≠odo da reserva</h3>
        <div className="row"><input type="datetime-local" value={start} onChange={e=>setStart(e.target.value)}/></div>
        <div className="row"><input type="datetime-local" value={end} onChange={e=>setEnd(e.target.value)}/></div>
        <div className="actions">
          <button onClick={onClose}>Fechar</button>
          <button className="primary" onClick={onSave}>Salvar</button>
        </div>
      </div>
    </div>
  );
}

function App(){
  const today=new Date();
  const[year,setYear]=React.useState(today.getFullYear());
  const[month,setMonth]=React.useState(today.getMonth()+1);
  const[data,setData]=React.useState(null);
  const[loading,setLoading]=React.useState(false);
  const[ctxOpen,setCtxOpen]=React.useState(false);
  const[ctxPos,setCtxPos]=React.useState({x:0,y:0});
  const[selectedRes,setSelectedRes]=React.useState(null);
  const[editOpen,setEditOpen]=React.useState(false);
  const[editStart,setEditStart]=React.useState("");
  const[editEnd,setEditEnd]=React.useState("");

  const load=async()=>{
    setLoading(true);
    try{
      const r=await fetch(`/reservas/api/gantt/?ano=${year}&mes=${month}&window=90`);
      const j=await r.json();
      setData(j);
    }finally{setLoading(false);}
  };
  React.useEffect(()=>{load();},[year,month]);

  const openCtx=(evt,res)=>{
    evt.stopPropagation();
    setSelectedRes(res);setCtxPos({x:evt.clientX,y:evt.clientY});setCtxOpen(true);
  };
  React.useEffect(()=>{
    const onDoc=()=>setCtxOpen(false);
    if(ctxOpen)document.addEventListener('click',onDoc);
    return()=>document.removeEventListener('click',onDoc);
  },[ctxOpen]);

  const patchReserva=async(payload)=>{
    if(!selectedRes)return;
    await fetch(`/reservas/api/reservas/${selectedRes.id}/`,{
      method:"PATCH",headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    setCtxOpen(false);setEditOpen(false);await load();
  };
  const confirmReserva=()=>patchReserva({status:"confirmada"});
  const cancelReserva=()=>patchReserva({status:"cancelada"});
  const openEditDates=()=>{
    if(!selectedRes)return;
    const toLocal=iso=>{
      const d=new Date(iso);const pad=n=>(n<10?"0"+n:n);
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };
    setEditStart(toLocal(selectedRes.start));setEditEnd(toLocal(selectedRes.end));
    setCtxOpen(false);setEditOpen(true);
  };
  const saveEditDates=()=>{
    const startISO=new Date(editStart).toISOString();
    const endISO=new Date(editEnd).toISOString();
    return patchReserva({start:startISO,end:endISO});
  };

  return(
    <div className="gantt-wrap">
      <Toolbar year={year} month={month} onMonthChange={(y,m)=>{setYear(y);setMonth(m);}} onReload={load}/>
      {loading&&<div style={{padding:"8px 0",color:"var(--muted)"}}>Carregando‚Ä¶</div>}
      {data&&<Grid data={data} onBarClick={openCtx}/>}
      {ctxOpen&&selectedRes&&<ContextMenu x={ctxPos.x} y={ctxPos.y} onConfirm={confirmReserva} onCancel={cancelReserva} onEdit={openEditDates}/>}
      {editOpen&&selectedRes&&<EditModal start={editStart} end={editEnd} setStart={setEditStart} setEnd={setEditEnd} onClose={()=>setEditOpen(false)} onSave={saveEditDates}/>}
    </div>
  );
}
const root=ReactDOM.createRoot(document.getElementById("HospedAIGantt"));
root.render(<App/>);
</script>
{% endverbatim %}
{% endblock %}

{% extends "core/base.html" %}
{% load static %}

{% block title %}HospedAI — Planejamento (Gantt){% endblock %}

{% block content %}
<style>
  :root{
    --ink:#0f172a;
    --muted:#6b7280;
    --primary:#4f46e5;
    --primary-2:#6366f1;
    --line:#e5e7eb;
    --bg:#f7f8fc;
    --row:#ffffff;
  }

  .gantt-toolbar{
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    margin: 8px 0 14px;
  }
  .gantt-toolbar .side{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .gantt-toolbar input[type="date"],
  .gantt-toolbar select,
  .gantt-toolbar button{
    border:1px solid var(--line); background:#fff; color:var(--ink);
    padding:.5rem .75rem; border-radius:10px; cursor:pointer;
  }
  .gantt-toolbar button:hover{ border-color: var(--primary); }

  .gantt-wrap{
    background:var(--bg);
    border-radius:14px; padding:14px;
    box-shadow: 0 6px 18px rgba(15,23,42,.06);
  }

  /* CONTAINER com scroll horizontal único para header+linhas */
  .gantt-grid{
    border:1px solid var(--line);
    border-radius:12px;
    background:#fff;
    overflow:hidden; /* arredondado bonito */
  }
  .scroller{
    display:grid;
    grid-template-columns: var(--labelW) auto; /* coluna do label + área timeline */
    max-width: 100%;
  }
  .labels{
    background:#fff; border-right:1px solid var(--line);
  }
  .timeline{
    overflow:auto; /* scroll horizontal aqui */
  }

  /* HEADER (dentro do scroller para rolar junto) */
  .header{
    display:grid;
    grid-template-columns: var(--labelW) auto;
    position:sticky; top:0; z-index:5;
    background:#fff; border-bottom:1px solid var(--line);
  }
  .header .left{
    padding:.75rem .9rem; font-weight:700; color:var(--ink);
    border-right:1px solid var(--line);
  }
  .header .right{
    position:relative;
  }
  .months{
    display:grid; height:32px; align-items:center;
    border-bottom:1px solid var(--line);
  }
  .month{
    text-align:center; font-weight:700; color:#374151; padding:.25rem 0;
    background:#fafafa; border-left:1px solid #f1f1f4;
  }
  .days{
    display:grid; height:34px; align-items:center;
  }
  .day{
    text-align:center; font-size:.9rem; border-left:1px solid var(--line);
    background:#fff;
  }

  /* LINHAS */
  .rows{
    display:block; /* cada linha vira uma grid própria */
  }
  .row{
    display:grid; grid-template-columns: var(--labelW) auto;
  }
  .label{
    padding:.65rem .9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    border-right:1px solid var(--line); border-bottom:1px solid var(--line);
    background:#fff;
  }
/* dentro do seu <style> existente */

/* tira a necessidade da .track-grid */
.track{
  position:relative;
  min-height:38px;
  border-bottom:1px solid var(--line);
  background:#fff;

  /* NOVO: linhas verticais de dia com gradient */
  /* --colW vem inline via React (ex.: 64px) */
  background-image: repeating-linear-gradient(
    to right,
    transparent 0,
    transparent calc(var(--colW) - 1px),
    #eef0f4 calc(var(--colW) - 1px),
    #eef0f4 var(--colW)
  );
  background-size: var(--colW) 100%;
  background-repeat: repeat-x;
  background-position: left top;
}

<!--  /* grade vertical dentro da trilha */-->
<!--  .track-grid{-->
<!--    position:absolute; inset:0; display:grid; pointer-events:none;-->
<!--  }-->
<!--  .track-grid > div{ border-left:1px dashed #eef0f4; }-->

  /* BARRAS */
  .bar{
    position:absolute; top:6px; height:26px; border-radius:8px;
    display:flex; align-items:center; gap:8px; padding:0 .55rem;
    color:#fff; font-weight:700; font-size:.86rem; letter-spacing:.2px;
    box-shadow: 0 6px 18px rgba(79,70,229,.25);
    overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
  }
  .bar.confirmada{ background:linear-gradient(90deg, var(--primary), var(--primary-2)); }
  .bar.pendente{ background:linear-gradient(90deg, #f59e0b, #fbbf24); }
  .bar.cancelada{ background:linear-gradient(90deg, #ef4444, #f87171); }

  .legend{
    display:flex; gap:12px; align-items:center; color:var(--muted);
  }
  .legend i{ width:14px; height:14px; display:inline-block; border-radius:4px; }
  .legend .c1{ background:linear-gradient(90deg, var(--primary), var(--primary-2)); }
  .legend .c2{ background:linear-gradient(90deg, #f59e0b, #fbbf24); }
  .legend .c3{ background:linear-gradient(90deg, #ef4444, #f87171); }
</style>

<div id="HospedAIGantt"></div>

<!-- React via CDN + Babel (somente dev/local) -->
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
{% verbatim %}
/** ========= Helpers ========= */
const LABEL_W = 180;       // px da coluna de “Quarto”
const COL_W   = 64;        // px por dia (ficou mais compacto)
const DAY_MS  = 24*3600*1000;

const pad = (n)=> n < 10 ? `0${n}` : `${n}`;
const toISODateLocal = (d)=> {
  const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  return dt.toISOString().slice(0,10);
};
const addDays = (d, n)=> new Date(d.getFullYear(), d.getMonth(), d.getDate()+n);

function monthName(date){
  return date.toLocaleDateString('pt-BR', {month:'long'});
}

/** Constrói vetor de dias e grupos por mês (para header com spans) */
function buildWindow(startISO, days){
  const start = new Date(startISO + "T00:00:00"); // local midnight
  const arr = [];
  for(let i=0;i<days;i++){
    const d = addDays(start, i);
    arr.push({
      date: d,
      iso: toISODateLocal(d),
      day: d.getDate(),
      month: d.getMonth(),   // 0..11
      year: d.getFullYear()
    });
  }
  // agrupa por mês
  const groups = [];
  for(const d of arr){
    const key = `${d.year}-${d.month}`;
    const label = `${monthName(d.date)} ${d.year}`;
    if(groups.length && groups[groups.length-1].key === key){
      groups[groups.length-1].span++;
    }else{
      groups.push({ key, label, span:1 });
    }
  }
  return { days: arr, groups };
}

/** Calcula posição da barra dentro da janela [start, start+days) */
function fracInWindow(startISO, endISO, windowStartISO, windowDays){
  const base = new Date(windowStartISO + "T00:00:00");
  const wEnd = new Date(base.getTime() + windowDays*DAY_MS);

  // ISO com timezone (ex.: +00:00) -> Date local
  const rs = new Date(startISO);
  const re = new Date(endISO);

  const clampStart = new Date(Math.max(rs, base));
  const clampEnd   = new Date(Math.min(re, wEnd));
  if (clampEnd <= base || clampStart >= wEnd) return [0,0]; // fora

  const fs = (clampStart - base)/DAY_MS;   // fração em “dias”
  const fe = (clampEnd   - base)/DAY_MS;

  // sanity clamps
  const s = Math.max(0, Math.min(fs, windowDays));
  const e = Math.max(s, Math.min(fe, windowDays));
  return [s, e];
}

/** ========= UI ========= */
function Toolbar({startISO, days, onChange, onReload}){
  // start no input = YYYY-MM-DD
  const [start, setStart] = React.useState(startISO);
  const [win, setWin] = React.useState(String(days));

  React.useEffect(()=>{ setStart(startISO); setWin(String(days)); }, [startISO, days]);

  const apply = ()=> onChange(start, parseInt(win,10));

  const nice = (() => {
    const d = new Date(start + "T00:00:00");
    return d.toLocaleDateString('pt-BR', {month:'long', year:'numeric'});
  })();

  return (
    <div className="gantt-toolbar">
      <div className="side">
        <strong>{nice}</strong>
      </div>
      <div className="side">
        <input type="date" value={start} onChange={e=>setStart(e.target.value)} />
        <select value={win} onChange={e=>setWin(e.target.value)}>
          <option value="30">30 dias</option>
          <option value="60">60 dias</option>
          <option value="90">90 dias</option>
        </select>
        <button onClick={apply}>Aplicar</button>
        <button onClick={onReload}>Recarregar</button>
      </div>
      <div className="legend">
        <span><i className="c1"></i> Confirmada</span>
        <span><i className="c2"></i> Pendente</span>
        <span><i className="c3"></i> Cancelada</span>
      </div>
    </div>
  );
}

function Header({days, groups}){
  const gridStyle = {
    '--labelW': LABEL_W + 'px'
  };
  const widthPx = days.length * COL_W + 'px';
  const colsDef = `repeat(${days.length}, ${COL_W}px)`;

  return (
    <div className="header" style={gridStyle}>
      <div className="left">Quarto</div>
      <div className="right">
        <div className="months" style={{ gridTemplateColumns: colsDef, width: widthPx }}>
          {groups.map((g, idx)=>(
            <div key={idx} className="month" style={{ gridColumn: `span ${g.span}` }}>{g.label}</div>
          ))}
        </div>
        <div className="days" style={{ gridTemplateColumns: colsDef, width: widthPx }}>
          {days.map((d, i)=> <div key={i} className="day">{d.day}</div>)}
        </div>
      </div>
    </div>
  );
}

function Row({room, windowStart, windowDays}){
  const widthPx = windowDays * COL_W + 'px';
  const colsDef = `repeat(${windowDays}, ${COL_W}px)`;

  return (
    <div className="row" style={{'--labelW': LABEL_W + 'px'}}>
      <div className="label" title={room.label}>{room.label}</div>

      {/* Passamos --colW para o CSS e definimos a largura da faixa */}
      <div className="track" style={{ '--colW': COL_W + 'px', width: widthPx }}>
        {/* REMOVIDO: a antiga <div className="track-grid"> */}

        {(room.reservas || []).map(r=>{
          const [fs, fe] = fracInWindow(r.start, r.end, windowStart, windowDays);
          const leftPx  = fs * COL_W;
          const width   = (fe - fs) * COL_W;
          if (width <= 0) return null;
          const cls = `bar ${r.status || 'confirmada'}`;
          return (
            <div
              key={r.id}
              className={cls}
              style={{ left:`${leftPx}px`, width:`${width}px` }}
              title={`${r.cliente || 'Reserva'} (${r.status || 'confirmada'}) • ${r.start} → ${r.end}`}
            >
              <span>{r.cliente || '—'}</span>
            </div>
          );
        })}
      </div>
    </div>
  );
}

function Grid({payload}){
  const startISO = payload.window_start;
  const windowDays = payload.window_days;
  const { days, groups } = buildWindow(startISO, windowDays);

  return (
    <div className="gantt-grid">
      {/* scroller contém header+linhas para rolar junto */}
      <div className="scroller" style={{'--labelW': LABEL_W + 'px'}}>
        <div className="labels"></div>
        <div className="timeline">
          <Header days={days} groups={groups} />
          <div className="rows">
            {payload.quartos.map(q=>(
              <Row key={q.id} room={q} windowStart={startISO} windowDays={windowDays} />
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

function App(){
  const today = new Date();
  const defaultStart = new Date(today.getFullYear(), today.getMonth(), 1);
  const [startISO, setStartISO] = React.useState(toISODateLocal(defaultStart));
  const [winDays, setWinDays]   = React.useState(60);  // escolha padrão
  const [data, setData]         = React.useState(null);
  const [loading, setLoading]   = React.useState(false);

  const load = async ()=>{
    setLoading(true);
    try{
      const url = `/reservas/api/gantt_window/?start=${startISO}&days=${winDays}`;
      const r = await fetch(url);
      const j = await r.json();
      setData(j);
    } finally {
      setLoading(false);
    }
  };

  React.useEffect(()=>{ load(); }, [startISO, winDays]);

  return (
    <div className="gantt-wrap">
      <Toolbar
        startISO={startISO}
        days={winDays}
        onChange={(s,d)=>{ setStartISO(s); setWinDays(d); }}
        onReload={load}
      />
      {loading && <div style={{padding:'8px 0', color:'#6b7280'}}>Carregando…</div>}
      {data && <Grid payload={data} />}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("HospedAIGantt"));
root.render(<App />);
{% endverbatim %}
</script>
{% endblock %}

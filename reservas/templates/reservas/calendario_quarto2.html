{% extends "core/base.html" %}
{% load static %}

{% block title %}HospedAI — Calendário{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'core/css/calendario.css' %}">

<div class="toolbar">
  <div class="filter-dates">
    <input type="date" id="checkinDate" aria-label="Data de início">
    <input type="date" id="checkoutDate" aria-label="Data de término">
    <button id="filterBtn">Filtrar</button>
  </div>

  <div class="month-nav" role="group" aria-label="Navegação do mês">
    <button id="prevMonth" class="btn-nav" aria-label="Mês anterior">◀</button>
    <strong id="monthLabel"></strong>
    <button id="nextMonth" class="btn-nav" aria-label="Próximo mês">▶</button>
    <button id="todayBtn" class="btn-nav">Hoje</button>
  </div>

  <div class="legend" aria-hidden="true">
    <span><i class="leg high"></i> Alta</span>
    <span><i class="leg mid"></i> Média</span>
    <span><i class="leg low"></i> Baixa</span>
  </div>
</div>

<div class="layout">
  <!-- ESQUERDA: CALENDÁRIO -->
  <section class="panel panel-calendar">
    <h2>Calendário Mensal</h2>
    <div class="calendar" id="calendar" role="grid" aria-label="Calendário de disponibilidade">
      <div class="calendar-header" role="columnheader">Dom</div>
      <div class="calendar-header" role="columnheader">Seg</div>
      <div class="calendar-header" role="columnheader">Ter</div>
      <div class="calendar-header" role="columnheader">Qua</div>
      <div class="calendar-header" role="columnheader">Qui</div>
      <div class="calendar-header" role="columnheader">Sex</div>
      <div class="calendar-header" role="columnheader">Sáb</div>
    </div>
  </section>

  <!-- DIREITA: DASHBOARD -->
  <aside class="panel panel-right">
    <h2>Dashboard do Dia</h2>
    <div class="dashboard" id="dashboard">
      <div class="card"><h3>Quartos Livres</h3><span id="freeRooms">0</span></div>
      <div class="card"><h3>Quartos Ocupados</h3><span id="occupiedRooms">0</span></div>
      <div class="card"><h3>Check-ins Hoje</h3><span id="checkinsToday">0</span></div>
      <div class="card"><h3>Check-outs Hoje</h3><span id="checkoutsToday">0</span></div>
    </div>
  </aside>

  <!-- LINHA DE LISTAS (abaixo do calendário + dashboard, largura total) -->
  <section class="panel lists-row">
    <div class="list-card">
      <h3>Quartos Livres</h3>
      <ul id="freeList"></ul>
    </div>
    <div class="list-card">
      <h3>Quartos Ocupados</h3>
      <ul id="occupiedList"></ul>
    </div>
    <div class="list-card">
      <h3>Check-ins Hoje</h3>
      <ul id="checkinList"></ul>
    </div>
  </section>

  <!-- KANBAN (opcional) -->
  <section class="panel kanban">
    <h2>Kanban de Quartos</h2>
    <div class="kanban-grid" id="kanbanGrid">
      <div class="kanban-column">
        <h4>Livre</h4>
        <div class="kanban-item">5</div>
        <div class="kanban-item">8</div>
        <div class="kanban-item">10</div>
      </div>
      <div class="kanban-column">
        <h4>Ocupado</h4>
        <div class="kanban-item">1 João Silva</div>
        <div class="kanban-item">2 Ana Souza</div>
        <div class="kanban-item">3 Fernanda Alves</div>
      </div>
      <div class="kanban-column">
        <h4>Pendente</h4>
        <div class="kanban-item">2 Maria Costa</div>
        <div class="kanban-item">4 Carlos Rocha</div>
      </div>
      <div class="kanban-column">
        <h4>Check-out hoje</h4>
        <div class="kanban-item">3 Pedro Lima</div>
        <div class="kanban-item">7 Luiza Almeida</div>
      </div>
    </div>
  </section>
</div>

<script>
/* ===== Helpers de data / labels ===== */
function toISODateLocal(d){
  const tz = d.getTimezoneOffset() * 60000;
  return new Date(d - tz).toISOString().slice(0,10);
}
function labelMes(dt){
  return dt.toLocaleDateString('pt-BR', { month:'long', year:'numeric' });
}
function setDefaultMonthRange(){
  const ci = document.getElementById('checkinDate');
  const co = document.getElementById('checkoutDate');
  if (ci.value && co.value) return;
  const today = new Date();
  const first = new Date(today.getFullYear(), today.getMonth(), 1);
  const nextFirst = new Date(today.getFullYear(), today.getMonth()+1, 1);
  const last = new Date(nextFirst - 1);
  ci.value = toISODateLocal(first);
  co.value = toISODateLocal(last);
  document.getElementById('monthLabel').textContent = labelMes(first);
}
function setMonthRange(baseDate){
  const first = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
  const nextFirst = new Date(baseDate.getFullYear(), baseDate.getMonth()+1, 1);
  const last = new Date(nextFirst - 1);
  document.getElementById('checkinDate').value = toISODateLocal(first);
  document.getElementById('checkoutDate').value = toISODateLocal(last);
  document.getElementById('monthLabel').textContent = labelMes(first);
}

/* ===== Renderização do calendário ===== */
async function carregarCalendario() {
  const checkin = document.getElementById('checkinDate').value;
  const checkout = document.getElementById('checkoutDate').value;

  const params = new URLSearchParams();
  if (checkin) params.append('data_entrada', checkin);
  if (checkout) params.append('data_saida', checkout);

  const calendar = document.getElementById('calendar');
  calendar.classList.add('loading');

  let res;
  try {
    res = await fetch(`/reservas/api/calendario/?${params.toString()}`);
  } catch (e) {
    calendar.classList.remove('loading');
    alert('Erro ao conectar com a API de calendário.');
    return;
  }
  if (!res.ok) {
    calendar.classList.remove('loading');
    alert('Falha ao carregar dados do calendário.');
    return;
  }
  const data = await res.json();

  calendar.innerHTML = `
    <div class="calendar-header" role="columnheader">Dom</div>
    <div class="calendar-header" role="columnheader">Seg</div>
    <div class="calendar-header" role="columnheader">Ter</div>
    <div class="calendar-header" role="columnheader">Qua</div>
    <div class="calendar-header" role="columnheader">Qui</div>
    <div class="calendar-header" role="columnheader">Sex</div>
    <div class="calendar-header" role="columnheader">Sáb</div>
  `;

  const hojeISO = new Date().toISOString().slice(0,10);

  data.calendario.forEach(d => {
    const dayDiv = document.createElement('div');
    dayDiv.classList.add('day');
    dayDiv.setAttribute('role', 'gridcell');

    const ocupados = (typeof d.occupied === 'number') ? d.occupied : (data.total_quartos - d.free);

    let availabilityClass = 'availability-high';
    if (d.free <= 1) availabilityClass = 'availability-low';
    else if (d.free <= 2) availabilityClass = 'availability-medium';

    dayDiv.innerHTML = `
      <strong>${d.day}</strong>
      <span class="free-info ${availabilityClass}">${d.free}/${data.total_quartos}</span>
      <div class="tip" aria-hidden="true">${ocupados} ocup.</div>
    `;

    if (d.date === hojeISO) dayDiv.classList.add('today');

    dayDiv.onclick = () => selecionarDia(dayDiv, d.date || hojeISO);
    calendar.appendChild(dayDiv);
  });

  calendar.classList.remove('loading');
  atualizarDashboard(data.dashboard);

  // Limpa listas; serão preenchidas ao selecionar um dia (se endpoint existir)
  document.getElementById('freeList').innerHTML = '';
  document.getElementById('occupiedList').innerHTML = '';
  document.getElementById('checkinList').innerHTML = '';
}

/* ===== Detalhes por dia (usa /reservas/api/detalhes/?dia=YYYY-MM-DD se disponível) ===== */
async function selecionarDia(el, dateStr){
  document.querySelectorAll('.day').forEach(d => d.classList.remove('selected'));
  el.classList.add('selected');

  try{
    const r = await fetch(`/reservas/api/detalhes/?dia=${dateStr}`);
    if (!r.ok) return; // se não existir, silenciosamente não preenche
    const det = await r.json();
    const fill = (id, arr) => {
      const ul = document.getElementById(id);
      ul.innerHTML = '';
      (arr || []).forEach(item=>{
        const li = document.createElement('li');
        // item: {room, checkout, cliente?}
        li.textContent = item.cliente
          ? `${item.room} — ${item.cliente} — saída ${item.checkout}`
          : `${item.room} — ${item.checkout}`;
        ul.appendChild(li);
      });
    };
    fill('freeList', det.free);
    fill('occupiedList', det.occupied);
    fill('checkinList', det.checkins);
  }catch(e){
    // sem endpoint ou erro — ignora
    console.warn('Endpoint de detalhes indisponível.');
  }
}

/* ===== Dashboard numérico ===== */
function atualizarDashboard(dash) {
  document.getElementById('freeRooms').textContent = dash.livres;
  document.getElementById('occupiedRooms').textContent = dash.ocupados;
  document.getElementById('checkinsToday').textContent = dash.checkins;
  document.getElementById('checkoutsToday').textContent = dash.checkouts;
}

/* ===== Navegação de mês ===== */
document.getElementById('prevMonth').onclick = ()=>{
  const ci = new Date(document.getElementById('checkinDate').value);
  ci.setMonth(ci.getMonth()-1);
  setMonthRange(ci);
  carregarCalendario();
};
document.getElementById('nextMonth').onclick = ()=>{
  const ci = new Date(document.getElementById('checkinDate').value);
  ci.setMonth(ci.getMonth()+1);
  setMonthRange(ci);
  carregarCalendario();
};
document.getElementById('todayBtn').onclick = ()=>{
  setMonthRange(new Date());
  carregarCalendario();
};

/* ===== Inicialização ===== */
document.getElementById('filterBtn').addEventListener('click', carregarCalendario);
setDefaultMonthRange();
carregarCalendario();
</script>
{% endblock %}
